name: Claude MCP Research Automation
# @akira_papa_ITæ°ã®Self-hosted Runnersæ‰‹æ³•ã‚’å‚è€ƒã«ã—ãŸå®Ÿè£…

on:
  workflow_dispatch:
    inputs:
      research_type:
        description: 'ãƒªã‚µãƒ¼ãƒã‚¿ã‚¤ãƒ—'
        required: true
        default: 'instant'
        type: choice
        options:
        - instant
        - deep
        - session
      query:
        description: 'ãƒªã‚µãƒ¼ãƒã‚¯ã‚¨ãƒª'
        required: true
        type: string
      save_to_obsidian:
        description: 'Obsidianã«ä¿å­˜'
        required: false
        default: true
        type: boolean

  schedule:
    # æ¯æ—¥9æ™‚ã«æŠ€è¡“ãƒˆãƒ¬ãƒ³ãƒ‰èª¿æŸ»
    - cron: '0 0 * * *'

  repository_dispatch:
    types: [research-trigger]

jobs:
  mcp-research:
    runs-on: self-hosted  # @akira_papa_ITæ¨å¥¨ã®self-hosted runners
    timeout-minutes: 5    # GitHub Actions 2,000åˆ†æ å†…ã§åŠ¹ç‡é‹ç”¨
    
    env:
      PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Verify MCP integration
      run: |
        # MCPçµ±åˆç¢ºèª
        claude mcp list
        
    - name: Execute Claude Max Integration Research
      id: research
      env:
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        # Claude APIç›´æ¥çµ±åˆã§ã®ãƒªã‚µãƒ¼ãƒå®Ÿè¡Œ
        QUERY="${{ github.event.inputs.query || 'AIæŠ€è¡“ãƒˆãƒ¬ãƒ³ãƒ‰ 2024' }}"
        TYPE="${{ github.event.inputs.research_type || 'instant' }}"
        
        echo "ğŸ” Starting Claude Max integrated research: $TYPE - $QUERY"
        
        # @akira_papa_ITæ–¹å¼: Claude APIç›´æ¥çµ±åˆ
        python3 claude_api_direct.py "$TYPE" "$QUERY"
        
        # çµæœãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        if [ -f "github_artifacts/research_report_"*".md" ]; then
          echo "research_success=true" >> $GITHUB_OUTPUT
          echo "report_file=$(ls github_artifacts/research_report_*.md | head -1)" >> $GITHUB_OUTPUT
        else
          echo "research_success=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Process results
      run: |
        # çµæœå‡¦ç†ã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        if [ -f "research_result.md" ]; then
          echo "ğŸ“Š Research result size: $(wc -l < research_result.md) lines"
          echo "research_success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Research failed"
          echo "research_success=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload to Obsidian
      if: ${{ github.event.inputs.save_to_obsidian == 'true' && steps.research.outputs.research_success == 'true' }}
      run: |
        # Obsidianè‡ªå‹•ä¿å­˜
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        FILENAME="GitHub_Actions_Research_${TIMESTAMP}.md"
        
        # Obsidianãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
        mkdir -p "./obsidian_exports"
        cp research_result.md "./obsidian_exports/$FILENAME"
        
        echo "ğŸ“ Saved to: obsidian_exports/$FILENAME"
        
    - name: Create Issue with results
      if: steps.research.outputs.research_success == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const result = fs.readFileSync('research_result.md', 'utf8');
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ” MCP Research Results: ${{ github.event.inputs.query }}`,
            body: `## GitHub Actions MCP Research\n\n${result}\n\n---\n*Generated by Claude MCP Research Automation*`
          });
          
    - name: Notify completion
      run: |
        echo "ğŸ‰ Claude MCP Research Automation completed!"
        echo "ğŸ“Š Usage tracking available via: claude mcp call perplexity-research perplexity_usage_stats"
        
    - name: Cleanup
      if: always()
      run: |
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        rm -f research_result.md
        
  schedule-research:
    if: github.event_name == 'schedule'
    runs-on: self-hosted
    timeout-minutes: 10
    
    steps:
    - name: Daily Tech Trend Research
      run: |
        # æ¯æ—¥ã®å®šæœŸãƒªã‚µãƒ¼ãƒ
        QUERIES=(
          "AIé–‹ç™º æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰"
          "Claude MCP æ–°æ©Ÿèƒ½"
          "GitHub Actions æœ€æ–°æƒ…å ±"
          "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° ãƒˆãƒ¬ãƒ³ãƒ‰ 2024"
        )
        
        for query in "${QUERIES[@]}"; do
          echo "ğŸ” Researching: $query"
          
          # MCPçµŒç”±ã§ãƒªã‚µãƒ¼ãƒå®Ÿè¡Œ
          claude --model sonnet <<EOF
          result = mcp__perplexity_research__perplexity_instant_search("$query")
          
          # çµæœã‚’æ—¥åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜
          import os
          from datetime import datetime
          
          date_str = datetime.now().strftime("%Y-%m-%d")
          os.makedirs(f"daily_research/{date_str}", exist_ok=True)
          
          safe_query = "$query".replace(" ", "_").replace("/", "_")
          with open(f"daily_research/{date_str}/{safe_query}.md", "w") as f:
              f.write(f"# {query}\n\n{result}")
          EOF
          
          sleep 30  # APIåˆ¶é™è€ƒæ…®
        done