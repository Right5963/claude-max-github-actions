name: Claude MCP Research Automation

on:
  workflow_dispatch:
    inputs:
      research_query:
        description: 'Research Query'
        required: true
        default: 'AI最新トレンド2025'

jobs:
  research:
    runs-on: self-hosted
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run Research with Perplexity
      env:
        PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
      run: |
        python research.py "${{ github.event.inputs.research_query }}"
    
    - name: Generate Report with Claude
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python generate_report.py
    
    - name: Upload Research Results
      uses: actions/upload-artifact@v3
      with:
        name: research-report
        path: |
          output/research_results.json
          output/research_report.md
          output/research_report.pdf
    
    - name: Create Issue with Results
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reportPath = 'output/research_report.md';
          
          if (fs.existsSync(reportPath)) {
            const report = fs.readFileSync(reportPath, 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Research Report: ${{ github.event.inputs.research_query }}`,
              body: report,
              labels: ['research', 'automated']
            });
          }
