# Claude CodeでMCPツールが使えない問題の分析（TAL手法）

## 問題の構造的理解

### 1. 現象の観察
```
観察 {
  状況: "claude mcp serve"は起動している
  設定: "claude mcp add"で9個のMCPサーバーを登録済み
  結果: AIからmcp_プレフィックスのツールが見えない
  
  推論 {
    可能性1: MCPツールへのアクセス権限の問題
    可能性2: AIの実行環境とMCPサーバー環境の分離
    可能性3: ツール登録の方法に問題がある
  }
}
```

### 2. アーキテクチャの分析
```
システム構造 {
  レイヤー1: Claude Desktop（MCPクライアント）
  レイヤー2: MCP Protocol（通信層）
  レイヤー3: Claude Code MCPサーバー
  レイヤー4: 登録されたMCPツール
  レイヤー5: Claude Code内のAI実行環境
  
  問題箇所 {
    レイヤー4→レイヤー5の接続が欠落
    理由: AIの実行環境がMCPツールを認識する仕組みがない
  }
}
```

### 3. 根本原因の特定
```
原因分析 {
  表面的原因: "mcp_"ツールが利用可能なツールリストに含まれていない
  
  中間的原因: {
    - AIの実行時にMCPツールが動的にロードされていない
    - ツール登録とAI環境の初期化が分離している
  }
  
  根本原因: {
    設計思想: Claude Code内のAIは標準ツールのみを使用する設計
    MCPツール: 外部クライアント（Claude Desktop）向けの設計
  }
}
```

## 解決策の探索

### アプローチ1: 環境変数による解決
```
仮説 {
  IF: 特定の環境変数でMCPツールを有効化できる
  THEN: AI起動時にその環境変数を設定
  
  検証方法 {
    export CLAUDE_ENABLE_MCP_TOOLS=true
    export CLAUDE_MCP_TOOLS_PATH=/path/to/mcp/tools
    claude mcp serve --enable-ai-tools
  }
}
```

### アプローチ2: 設定ファイルによる解決
```
仮説 {
  IF: .mcp.jsonや設定ファイルでAI環境を制御できる
  THEN: ツール登録時にAI用の設定を追加
  
  検証方法 {
    作成: .mcp.json {
      "aiAccess": true,
      "exposeTools": ["obsidian", "filesystem"],
      "toolPrefix": "mcp_"
    }
  }
}
```

### アプローチ3: プロキシサーバーによる解決
```
実装案 {
  概念: 標準ツールをMCPツールにブリッジするプロキシ
  
  動作フロー {
    1. AIが標準のTaskツールを使用
    2. Task内でMCPツールを呼び出すスクリプトを実行
    3. 結果をAIに返す
  }
  
  実装例 {
    Task("MCPツールを使う") {
      内部処理: claude mcp invoke obsidian search_notes '{"query": "TAL"}'
      結果返却: JSON形式でAIに返す
    }
  }
}
```

### アプローチ4: カスタムツールの作成
```
実装案 {
  概念: MCPツールと同等の機能を持つカスタムツールを作成
  
  方法 {
    1. Claude Codeのプラグイン機構を調査
    2. カスタムツールの登録方法を確認
    3. MCPツールのラッパーを作成
  }
}
```

## 実践的な回避策

### 即効性のある解決策
```
現実的アプローチ {
  前提: 現在の制限を受け入れる
  
  解決策 {
    1. PowerShell/Bashスクリプトでファイル操作
    2. Taskツールで複雑な処理を実行
    3. 結果をAIが解釈して応答
  }
  
  利点 {
    - 即座に実装可能
    - 追加設定不要
    - 安定動作
  }
}
```

## 推奨される次のステップ

```
行動計画 {
  優先度高 {
    1. 公式ドキュメントでMCPツールのAI統合方法を確認
    2. claude mcp serveのオプションを調査（--help）
    3. 環境変数の影響を検証
  }
  
  優先度中 {
    1. .mcp.jsonの詳細仕様を調査
    2. カスタムツール作成の可能性を検討
    3. コミュニティフォーラムで情報収集
  }
  
  優先度低 {
    1. プロキシサーバーの実装
    2. 代替ツールチェーンの構築
  }
}
```

## 結論

```
現状認識 {
  制限: Claude Code内のAIは設計上MCPツールに直接アクセスできない
  理由: セキュリティとアーキテクチャの分離
  
  推奨対応 {
    短期: PowerShell/Bash経由でのファイル操作を継続
    中期: 公式のアップデートを待つ
    長期: より統合されたツールの登場を期待
  }
}
```